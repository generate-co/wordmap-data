<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Word Map - Three.js v1.0.0</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }
    #search {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1;
      padding: 6px;
      font-size: 16px;
      background: rgba(255,255,255,0.9);
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #version {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1;
      color: #fff;
      font-family: monospace;
      font-size: 12px;
      background: rgba(0,0,0,0.5);
      padding: 4px 8px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <input id="search" type="text" placeholder="Search word..." />
  <div id="version">v1.0.0</div>
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 2000);
    camera.position.z = 600;

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.5;

    const loader = new THREE.TextureLoader();
    const fontLoader = new THREE.FontLoader();

    const URL = 'word_positions_1500000_clean.json?t=' + Date.now();
    let allData = [];

    fetch(URL)
      .then(res => res.json())
      .then(json => {
        allData = json.filter(d => d.word && d.x != null && d.y != null && d.z != null);

        // 正規化
        const xExtent = d3.extent(allData, d => d.x);
        const yExtent = d3.extent(allData, d => d.y);
        const zExtent = d3.extent(allData, d => d.z);
        const xScale = d3.scaleLinear().domain(xExtent).range([-300, 300]);
        const yScale = d3.scaleLinear().domain(yExtent).range([-300, 300]);
        const zScale = d3.scaleLinear().domain(zExtent).range([-300, 300]);

        allData.forEach(d => {
          d.x = xScale(d.x);
          d.y = yScale(d.y);
          d.z = zScale(d.z);
        });

        focusOn('perform');
      });

    function focusOn(targetWord) {
      const target = allData.find(d => d.word.toLowerCase() === targetWord.toLowerCase());
      if (!target) return alert("Word not found");

      const nearby = allData.map(d => {
        const dx = d.x - target.x;
        const dy = d.y - target.y;
        const dz = d.z - target.z;
        const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);
        return { ...d, dist };
      }).sort((a, b) => a.dist - b.dist).slice(0, 1500);

      // 文字のSpriteを配置
      const material = new THREE.SpriteMaterial({ color: 0xffffff });
      for (const d of nearby) {
        const sprite = new THREE.Sprite(material.clone());
        sprite.position.set(d.x, d.y, d.z);
        sprite.scale.set(20, 10, 1);
        sprite.material.opacity = THREE.MathUtils.clamp(1 - Math.abs(d.z) / 300, 0.2, 1);
        sprite.material.transparent = true;
        scene.add(sprite);
      }
    }

    document.getElementById('search').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const word = e.target.value.trim();
        if (word) {
          // Clear scene and re-focus
          while (scene.children.length > 0) {
            scene.remove(scene.children[0]);
          }
          focusOn(word);
        }
      }
    });

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</body>
</html>

<script>
const canvas = document.querySelector("canvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const WIDTH = canvas.width;
const HEIGHT = canvas.height;
let transform = d3.zoomIdentity;

const URL = "word_positions_1500000_clean.json?t=" + Date.now(); // キャッシュバスター
let data = [];

fetch(URL)
  .then(res => res.json())
  .then(json => {
    data = json;

    // データの範囲（元の座標は -10〜10とかかも）
    const xExtent = d3.extent(data, d => d.x);
    const yExtent = d3.extent(data, d => d.y);

    // キャンバス座標への変換
    xScale = d3.scaleLinear().domain(xExtent).range([0, WIDTH]);
    yScale = d3.scaleLinear().domain(yExtent).range([0, HEIGHT]);

    render(); // 初回描画
  });

function render() {
  ctx.clearRect(0, 0, WIDTH, HEIGHT);
  ctx.save();
  ctx.translate(transform.x, transform.y);
  ctx.scale(transform.k, transform.k);

  for (let i = 0; i < data.length; i++) {
    const d = data[i];
    const fontSize = 10;
    const screenSize = fontSize * transform.k;
    if (screenSize < 3) continue;

    const x = xScale(d.x);
    const y = yScale(d.y);

    ctx.font = `${fontSize}px sans-serif`;
    ctx.fillStyle = "black";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(d.word, x, y);
  }

  ctx.restore();
}

const zoom = d3.zoom()
  .scaleExtent([0.1, 50])
  .on("zoom", (event) => {
    transform = event.transform;
    render();
  });

d3.select(canvas).call(zoom);
</script>